name: QA

on:
  push:
    branches:
      - main
  pull_request:
     branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  APP_URL: http://localhost:81/ui/#/
  CXBOX_LOGGER:  true

jobs:
  build-qa-pr-and-check-autotests:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
    - name: Очистка runner перед сборкой
      run: |
        echo "=== Очистка GitHub Actions runner ==="
        
        # Логи и диагностика
        DIAG_DIR="${RUNNER_TOOL_CACHE}/../_diag"
        if [ -d "$DIAG_DIR" ]; then
          echo "Очищаем логи и диагностику: $DIAG_DIR"
          rm -rf "$DIAG_DIR"/*
        fi
        
        # Кэш runner-а
        CACHED_DIR="${RUNNER_TOOL_CACHE}/../cached"
        WORK_DIR="${RUNNER_WORKSPACE}"
        
        if [ -d "$CACHED_DIR" ]; then
          echo "Очищаем кэш runner-а: $CACHED_DIR"
          rm -rf "$CACHED_DIR"/*
        fi
        
        if [ -d "$WORK_DIR" ]; then
          echo "Очищаем рабочие директории: $WORK_DIR"
          rm -rf "$WORK_DIR"/*
        fi
        
        # Allure history
        for dir in $WORK_DIR/*/allure-history; do
          if [ -d "$dir" ]; then
            echo "Очищаем Allure history: $dir"
            rm -rf "$dir"/*
          fi
        done
        
        echo "=== Место на диске после очистки ==="
        df -h