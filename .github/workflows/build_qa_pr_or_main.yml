name: QA

on:
  push:
    branches:
      - main
  pull_request:
     branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  APP_URL: http://localhost:81/ui/#/
  CXBOX_LOGGER:  true
  GH_TOKEN: ${{ github.token }}

jobs:
  build-qa-pr-and-check-autotests:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Check and cleanup disk on self-hosted runner
        if: always()
        run: |
                echo ">>> Disk usage BEFORE cleanup:"
                df -h
                
                echo ">>> Top 10 biggest folders BEFORE cleanup:"
                du -ah /home/runner 2>/dev/null | sort -rh | head -n 10 || true
      - name: Check inode usage
        run: |
          echo "INODE USAGE:"
          df -i
      - name: Check disk space
        run: df -h
      - name: Check runner directories size
        run: du -h --max-depth=1 /home/runner/actions-runner | sort -h
      - name: Check diag blocks
        run: du -h --max-depth=1 /home/runner/actions-runner/cached/_diag/blocks | sort -h
      - name: Find largest cached diag files
        run: |
          find /home/runner/actions-runner/cached/_diag/blocks -type f -printf "%s %p\n" \
          | sort -nr | head -n 20
      - name: Check diag permissions
        run: |
          ls -ld /home/runner/actions-runner/cached/_diag
          ls -l /home/runner/actions-runner/cached/_diag | head

      - name: Test write into _diag
        run: |
          echo "Testing write..." > /home/runner/actions-runner/cached/_diag/test.log
          echo "Write OK"
      - name: Check kernel errors
        run: |
          dmesg | tail -n 30
