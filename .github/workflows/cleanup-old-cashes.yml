name: Manual Cache Cleanup

# Trigger only manually
on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Select branch to clean caches from'
        required: true
        type: choice
        options:
          - main

jobs:
  cleanup-old-caches:
    runs-on: ubuntu-latest
    steps:
      - name: Check inode usage
        run: |
          echo "INODE USAGE:"
          df -i
      - name: Check disk space
        run: df -h
      - name: Top 10 biggest folders
        run:  du -ah /home/runner 2>/dev/null | sort -rh | head -n 10 || true
      - name: Check runner directories size
        run: du -h --max-depth=1 /home/runner/actions-runner | sort -h
      - name: Check diag blocks
        run: du -h --max-depth=1 /home/runner/actions-runner/cached/_diag/blocks | sort -h
      - name: Find largest cached diag files
        run: |
          find /home/runner/actions-runner/cached/_diag/blocks -type f -printf "%s %p\n" \
          | sort -nr | head -n 20
      - name: Check diag permissions
        run: |
          ls -ld /home/runner/actions-runner/cached/_diag
          ls -l /home/runner/actions-runner/cached/_diag | head

      - name: Test write into _diag
        run: |
          echo "Testing write..." > /home/runner/actions-runner/cached/_diag/test.log
          echo "Write OK"
      - name: Check kernel errors
        run: |
          dmesg | tail -n 30
      - name: Check runner quota
        run: |
          echo "Space available for runner user:"
          df -h /home/runner/actions-runner
          echo "Disk usage inside actions-runner:"
          du -sh /home/runner/actions-runner/*
      - name: Check permissions before gh-pages clone
        run: |
          echo "Checking cached directory..."
          ls -la /home/runner/actions-runner/cached || true
          
          echo "Checking gh-pages temp dirs..."
          find /home/runner/actions-runner -maxdepth 4 -name "*gh-pages*" -print || true
      - name: Check for leftover .git dirs
        run: |
          find /home/runner/actions-runner -type d -name ".git" | head
      - name: Check auth token length
        run: |
          echo "TOKEN LENGTH: ${#GITHUB_TOKEN}"

      - name: Check git remote access
        run: |
          git ls-remote https://github.com/CX-Box/cxbox-code-samples-allure.git
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set branch variable
        run: echo "BRANCH=${{ github.event.inputs.branch }}" >> $GITHUB_ENV

      - name: Cleanup old caches
        run: |
          echo "Fetching list of cache keys for branch $BRANCH"
          
          # Get cache IDs and creation dates
          cacheInfo=$(gh cache list --ref $BRANCH --limit 100 --json id,createdAt)

          # Current date in seconds since 1970
          now=$(date +%s)
          
          # Iterate over each cache
          echo "$cacheInfo" | jq -c '.[]' | while read cache; do
            cacheId=$(echo "$cache" | jq -r '.id')
            createdAt=$(echo "$cache" | jq -r '.createdAt')
          
            # Convert cache creation date to seconds
            cacheTime=$(date -d "$createdAt" +%s)
          
            # Calculate difference in days
            diffDays=$(( (now - cacheTime) / 86400 ))
          
            # Delete if cache is older than 7 days
            if [ "$diffDays" -gt 7 ]; then
              echo "Deleting cache $cacheId (created $diffDays days ago)"
              gh cache delete "$cacheId" || true
            fi
          done

          echo "Old cache cleanup done"
