name: Manual Cache Cleanup

# Trigger only manually
on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Select branch to clean caches from'
        required: true
        type: choice
        options:
          - main
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GITHUB_REF_NAME: ${{ github.ref_name }}

jobs:
  cleanup-old-caches:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old caches
        run: |
          echo "Fetching list of cache keys for branch $BRANCH"
          
          # Get cache IDs and creation dates
          cacheInfo=$(gh cache list --ref $BRANCH --limit 100 --json id,createdAt)

          # Current date in seconds since 1970
          now=$(date +%s)
          
          # Iterate over each cache
          echo "$cacheInfo" | jq -c '.[]' | while read cache; do
            cacheId=$(echo "$cache" | jq -r '.id')
            createdAt=$(echo "$cache" | jq -r '.createdAt')
          
            # Convert cache creation date to seconds
            cacheTime=$(date -d "$createdAt" +%s)
          
            # Calculate difference in days
            diffDays=$(( (now - cacheTime) / 86400 ))
          
            # Delete if cache is older than 7 days
            if [ "$diffDays" -gt 7 ]; then
              echo "Deleting cache $cacheId (created $diffDays days ago)"
              gh cache delete "$cacheId" || true
            fi
          done

          echo "Old cache cleanup done"
